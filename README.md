# WazMeow - API REST para WhatsApp

Uma API REST completa para gerenciar sess√µes do WhatsApp usando Go e a biblioteca whatsmeow.

## üöÄ Funcionalidades

- ‚úÖ Criar e gerenciar m√∫ltiplas sess√µes do WhatsApp
- ‚úÖ Autentica√ß√£o via QR Code
- ‚úÖ Emparelhamento por telefone
- ‚úÖ Configura√ß√£o de proxy
- ‚úÖ Conex√£o e desconex√£o de sess√µes
- ‚úÖ Logout de sess√µes
- ‚úÖ Listagem e informa√ß√µes detalhadas das sess√µes
- ‚úÖ Event handlers completos para mensagens, presen√ßa, confirma√ß√µes de leitura
- ‚úÖ Reconex√£o autom√°tica de sess√µes na inicializa√ß√£o
- ‚úÖ Gerenciamento de m√≠dia (imagens, √°udios, v√≠deos, documentos)
- ‚úÖ Sistema completo de webhooks com payload bruto
- ‚úÖ Filtros de eventos configur√°veis
- ‚úÖ Sistema de retry e circuit breaker
- ‚úÖ Rate limiting por sess√£o
- ‚úÖ M√©tricas de performance
- ‚úÖ Graceful shutdown com desconex√£o de todas as sess√µes

## üèóÔ∏è Tecnologias

- **Backend**: Go 1.23+ com Clean Architecture
- **ORM**: Bun ORM com auto-migra√ß√µes
- **Banco de dados**: PostgreSQL 15+
- **WhatsApp**: whatsmeow library com event handlers completos
- **HTTP Router**: Chi v5
- **Containeriza√ß√£o**: Docker & Docker Compose

## ‚ö° Comandos R√°pidos (Makefile)

O projeto inclui um Makefile com comandos para facilitar o desenvolvimento:

```bash
# Ver todos os comandos dispon√≠veis
make help

# Setup completo para desenvolvimento
make setup

# Desenvolvimento r√°pido (Docker + app)
make quick

# Comandos b√°sicos
make build          # Compila a aplica√ß√£o
make run            # Compila e executa
make dev            # Executa em modo desenvolvimento
make test           # Executa testes
make clean          # Limpa arquivos de build

# Docker Compose
make docker-up      # Inicia PostgreSQL, Redis, DBGate, Webhook Tester
make docker-down    # Para todos os servi√ßos
make docker-logs    # Mostra logs dos servi√ßos
make status         # Status dos servi√ßos

# Qualidade de c√≥digo
make fmt            # Formata c√≥digo
make vet            # Executa go vet
make lint           # Executa linter
make check          # Formata + vet + testes

# Documenta√ß√£o Swagger
make swagger-gen    # Gera documenta√ß√£o Swagger
make swagger-serve  # Gera documenta√ß√£o e inicia servidor
make swagger-clean  # Remove arquivos de documenta√ß√£o
```

## üì± Implementa√ß√£o WhatsApp

A implementa√ß√£o do WhatsApp foi baseada no arquivo de refer√™ncia `@reference/wuzapi/wmiau.go` e inclui:

### üîß Componentes Principais

- **WhatsAppClient**: Wrapper completo do cliente whatsmeow com event handlers
- **SessionManager**: Gerenciador de sess√µes ativas com thread-safety
- **ClientFactory**: Factory para cria√ß√£o e configura√ß√£o de clientes
- **Event Handlers**: Tratamento completo de eventos do WhatsApp

### üì® Eventos Suportados

- **Conex√£o**: Connected, Disconnected, LoggedOut
- **Autentica√ß√£o**: QR Code generation, PairSuccess
- **Mensagens**: Recebimento de mensagens de texto e m√≠dia
- **Confirma√ß√µes**: Read receipts, delivery confirmations
- **Presen√ßa**: Online/offline status, chat presence
- **M√≠dia**: Processamento de imagens, √°udios, v√≠deos e documentos

### üîÑ Funcionalidades Avan√ßadas

- **Reconex√£o Autom√°tica**: Sess√µes conectadas s√£o automaticamente reconectadas na inicializa√ß√£o
- **Graceful Shutdown**: Desconex√£o limpa de todas as sess√µes ao parar o servidor
- **Thread Safety**: Opera√ß√µes thread-safe em todos os componentes
- **Error Handling**: Tratamento robusto de erros e recupera√ß√£o de falhas

## üìã Endpoints da API

| M√©todo | Endpoint                                      | Descri√ß√£o                                                                 |
|--------|-----------------------------------------------|--------------------------------------------------------------------------|
| POST   | `/sessions/add`                               | Cria uma nova sess√£o do WhatsApp                                        |
| GET    | `/sessions/list`                              | Lista todas as sess√µes ativas e registradas no sistema                  |
| GET    | `/sessions/{sessionID}/info`                  | Retorna as informa√ß√µes detalhadas de uma sess√£o espec√≠fica              |
| DELETE | `/sessions/{sessionID}`                       | Remove permanentemente uma sess√£o existente do sistema                  |
| POST   | `/sessions/{sessionID}/connect`               | Estabelece a conex√£o da sess√£o com o WhatsApp                           |
| POST   | `/sessions/{sessionID}/logout`                | Faz logout da sess√£o do WhatsApp, encerrando a comunica√ß√£o              |
| GET    | `/sessions/{sessionID}/qr`                    | Gera e retorna o QR Code necess√°rio para autenticar a sess√£o            |
| POST   | `/sessions/{sessionID}/pairphone`             | Emparelha um telefone com a sess√£o                                      |
| POST   | `/sessions/{sessionID}/proxy/set`             | Configura proxy para a sess√£o                                           |
| GET    | `/health`                                     | Health check da API                                                      |

### üîó Endpoints de Webhook

| M√©todo | Endpoint                                      | Descri√ß√£o                                                                 |
|--------|-----------------------------------------------|--------------------------------------------------------------------------|
| POST   | `/sessions/{sessionID}/webhook`               | Configura webhook para receber eventos da sess√£o                        |
| GET    | `/sessions/{sessionID}/webhook`               | Obt√©m configura√ß√£o atual do webhook                                     |
| PUT    | `/sessions/{sessionID}/webhook`               | Atualiza configura√ß√£o do webhook (ativar/desativar)                     |
| DELETE | `/sessions/{sessionID}/webhook`               | Remove configura√ß√£o do webhook                                          |
| POST   | `/sessions/{sessionID}/webhook/test`          | Testa conectividade do webhook                                          |
| GET    | `/webhook/events`                             | Lista eventos suportados e grupos dispon√≠veis                          |

## üîó Sistema de Webhooks

O WazMeow possui um sistema completo de webhooks que permite receber eventos do WhatsApp em tempo real.

### ‚ú® Caracter√≠sticas

- **Payload Bruto**: Eventos enviados exatamente como v√™m do whatsmeow
- **Filtros Configur√°veis**: Escolha quais eventos receber
- **Sistema de Retry**: Tentativas autom√°ticas com backoff exponencial
- **Circuit Breaker**: Prote√ß√£o contra URLs com falhas consecutivas
- **Rate Limiting**: Controle de taxa por sess√£o
- **M√©tricas**: Monitoramento completo de performance

### üìù Configura√ß√£o R√°pida

```bash
# Configurar webhook para receber todos os eventos
curl -X POST http://localhost:8080/sessions/minha-sessao/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "webhook": "http://localhost:8090/webhook",
    "events": ["*"]
  }'
```

### üß™ Testando Webhooks

O ambiente de desenvolvimento inclui um webhook-tester para facilitar os testes:

```bash
# Iniciar o ambiente de desenvolvimento
docker-compose up -d

# O webhook-tester estar√° dispon√≠vel em:
# http://localhost:8090
```

**URLs √∫teis para desenvolvimento:**
- **Webhook Tester**: http://localhost:8090 (para testar webhooks)
- **DBGate**: http://localhost:3000 (administra√ß√£o de banco)
- **WazMeow API**: http://localhost:8080 (API principal)

### üìã Eventos Dispon√≠veis

- **Conex√£o**: `connected`, `disconnected`, `logged_out`, `qr`, `pair_success`
- **Mensagens**: `message`, `receipt`
- **Presen√ßa**: `presence`, `chatpresence`
- **Grupos**: `groupinfo`, `joinedgroup`
- **M√≠dia**: `picture`
- **Chamadas**: `calloffer`, `callaccept`, `callterminate`

### üìñ Documenta√ß√£o Completa

Para documenta√ß√£o detalhada sobre webhooks, consulte: [docs/webhooks.md](docs/webhooks.md)

Para exemplo de implementa√ß√£o, veja: [examples/webhook_server.js](examples/webhook_server.js)

## üìö Documenta√ß√£o Swagger

A API WazMeow inclui documenta√ß√£o Swagger completa e interativa para todos os endpoints.

### üåê Acessar Documenta√ß√£o

1. **Inicie o servidor**:
   ```bash
   go run cmd/server/main.go
   ```

2. **Acesse a interface Swagger UI**:
   ```
   http://localhost:8080/swagger/
   ```

### üîß Gerar Documenta√ß√£o

Para gerar ou atualizar a documenta√ß√£o Swagger:

```bash
# Usando o script
./scripts/generate-docs.sh

# Ou usando o Makefile
make swagger-gen

# Ou manualmente
swag init -g cmd/server/main.go -o docs/ --parseDependency --parseInternal
```

### üìã Comandos Make Dispon√≠veis

```bash
make swagger-gen     # Gera documenta√ß√£o Swagger
make swagger-serve   # Gera documenta√ß√£o e inicia servidor
make swagger-clean   # Remove arquivos de documenta√ß√£o gerados
```

### üìñ Funcionalidades da Documenta√ß√£o

- ‚úÖ **Interface Interativa**: Teste todos os endpoints diretamente no navegador
- ‚úÖ **Esquemas Completos**: Documenta√ß√£o detalhada de todos os DTOs e entidades
- ‚úÖ **Exemplos de Uso**: Exemplos pr√°ticos para cada endpoint
- ‚úÖ **Valida√ß√µes**: Documenta√ß√£o de todas as valida√ß√µes de entrada
- ‚úÖ **C√≥digos de Resposta**: Documenta√ß√£o completa de respostas de sucesso e erro
- ‚úÖ **Tags Organizadas**: Endpoints organizados por funcionalidade (sessions, messages, health)

### üîó Endpoints Documentados

- **Sessions**: Cria√ß√£o, listagem, conex√£o, logout, QR code, emparelhamento, proxy
- **Messages**:
  - **B√°sicas**: Texto, m√≠dia gen√©rica
  - **Espec√≠ficas**: Imagem, √°udio, v√≠deo, documento, sticker
  - **Interativas**: Localiza√ß√£o, contato, bot√µes, lista, enquete
  - **Opera√ß√µes**: Editar, deletar, reagir
- **Health**: Verifica√ß√£o de sa√∫de da API

## üõ†Ô∏è Instala√ß√£o e Execu√ß√£o

### Pr√©-requisitos

- Go 1.23 ou superior
- PostgreSQL 15+
- Docker (opcional, para desenvolvimento)

### Instala√ß√£o

1. Clone o reposit√≥rio:
```bash
git clone <repository-url>
cd wazmeow
```

2. Instale as depend√™ncias:
```bash
go mod tidy
```

3. Execute o servidor:
```bash
go run cmd/server/main.go
```

O servidor ser√° iniciado na porta 8080 por padr√£o.

### Vari√°veis de Ambiente

- `PORT`: Porta do servidor (padr√£o: 8080)
- `LOG_LEVEL`: N√≠vel de log (DEBUG, INFO, WARN, ERROR - padr√£o: INFO)
- `DATA_DIR`: Diret√≥rio para armazenar dados (padr√£o: ./data)

## üìñ Exemplos de Uso

### Criar uma nova sess√£o

```bash
curl -X POST http://localhost:8080/sessions/add \
  -H "Content-Type: application/json" \
  -d '{"name": "Minha Sess√£o"}'
```

### Listar todas as sess√µes

```bash
curl http://localhost:8080/sessions/list
```

### Obter QR Code para autentica√ß√£o

```bash
curl http://localhost:8080/sessions/{sessionID}/qr
```

### Conectar uma sess√£o

```bash
curl -X POST http://localhost:8080/sessions/{sessionID}/connect
```

### Emparelhar telefone

```bash
curl -X POST http://localhost:8080/sessions/{sessionID}/pairphone \
  -H "Content-Type: application/json" \
  -d '{"phone": "+5511999999999"}'
```

### Configurar proxy

```bash
curl -X POST http://localhost:8080/sessions/{sessionID}/proxy/set \
  -H "Content-Type: application/json" \
  -d '{
    "type": "http",
    "host": "proxy.example.com",
    "port": 8080,
    "username": "user",
    "password": "pass"
  }'
```

### Fazer logout

```bash
curl -X POST http://localhost:8080/sessions/{sessionID}/logout
```

### Remover sess√£o

```bash
curl -X DELETE http://localhost:8080/sessions/{sessionID}
```

## üìÅ Estrutura do Projeto

```
wazmeow/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îî‚îÄ‚îÄ main.go              # Ponto de entrada da aplica√ß√£o
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session_handler.go  # Handlers HTTP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.go            # Configura√ß√£o das rotas
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session.go           # Modelos de dados
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ session_service.go   # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ pkg/
‚îÇ   ‚îî‚îÄ‚îÄ logger/
‚îÇ       ‚îî‚îÄ‚îÄ logger.go            # Logger personalizado
‚îú‚îÄ‚îÄ go.mod                       # Depend√™ncias do Go
‚îî‚îÄ‚îÄ README.md                    # Documenta√ß√£o
```

## üîß Tecnologias Utilizadas

- **Go 1.21**: Linguagem de programa√ß√£o
- **Chi Router**: Roteador HTTP leve e r√°pido
- **WhatsApp Web Multi-Device**: Biblioteca whatsmeow
- **SQLite**: Banco de dados para armazenar sess√µes
- **UUID**: Gera√ß√£o de identificadores √∫nicos

## üìù Formato das Respostas

Todas as respostas da API seguem o formato padr√£o:

```json
{
  "success": true,
  "message": "Mensagem descritiva",
  "data": {}, // Dados da resposta (opcional)
  "error": "" // Mensagem de erro (opcional)
}
```

## üö® Tratamento de Erros

A API retorna c√≥digos de status HTTP apropriados:

- `200`: Sucesso
- `400`: Erro de valida√ß√£o ou dados inv√°lidos
- `404`: Recurso n√£o encontrado
- `500`: Erro interno do servidor

## üîí Seguran√ßa

- Valida√ß√£o de entrada em todos os endpoints
- Tratamento seguro de erros
- Logs estruturados para auditoria
- Suporte a CORS configur√°vel

## üìû Suporte

Para d√∫vidas ou problemas, abra uma issue no reposit√≥rio do projeto.

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo LICENSE para mais detalhes.
